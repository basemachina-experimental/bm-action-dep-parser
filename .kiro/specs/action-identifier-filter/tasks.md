# 実装計画

## 概要

この実装計画は、`bm-action-dep-parser`にアクション識別子によるフィルタリング機能を追加するためのタスクを定義します。各タスクは1〜3時間程度で完了可能な単位に分割されており、順次実行することで機能を段階的に構築します。

## タスク一覧

- [x] 1. フィルタリング機能の基盤実装
- [x] 1.1 依存関係フィルタリングのコアロジックを実装
  - アクション識別子の配列を受け取り、指定されたアクションに依存するエントリーポイントを抽出する関数を作成
  - ビュー依存関係とアクション依存関係の両方に対応する汎用的なフィルタリングアルゴリズムを実装
  - 直接依存と間接依存の両方を考慮した逆引き探索を実装
  - OR論理で複数のアクション識別子に対応（いずれかに依存するエントリーポイントを抽出）
  - _Requirements: 1.1, 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3_

- [x] 1.2 フィルタリング結果の型定義を追加
  - フィルタリング結果を表す型（フィルタされた依存関係と警告メッセージを含む）を定義
  - 既存の`ViewDependency`と`JavaScriptActionDependency`型との互換性を維持
  - 型安全性を確保し、`any`型を使用しない
  - _Requirements: 4.1, 4.2, 4.3, 6.3_

- [x] 2. CLI引数解析の拡張
- [x] 2.1 --filter-actionオプションの解析ロジックを追加
  - コマンドライン引数から`--filter-action`オプションを検出し、値を抽出する処理を実装
  - カンマ区切りの複数アクション識別子をパースして配列に変換
  - 空文字列や空白のみのトークンを除外
  - パース結果を`undefined`または`string[]`として返却
  - _Requirements: 1.1, 1.3_

- [x] 2.2 入力検証とエラーハンドリングを実装
  - `--filter-action`の引数が空文字列または無効な形式の場合にエラーメッセージを表示
  - エラー時に終了コード1でプロセスを終了
  - 日本語のエラーメッセージで明確なフィードバックを提供
  - _Requirements: 5.3_

- [x] 2.3 既存オプションとの共存を確認
  - `--entry-point-patterns`など既存オプションとの組み合わせで正常に動作することを確認
  - オプション解析ループの拡張が他のオプションに影響しないことを検証
  - _Requirements: 6.2_

- [x] 3. メイン解析ロジックへのフィルタリング統合
- [x] 3.1 analyzeActionDependencies関数にフィルタリング処理を統合
  - オプショナルパラメータとして`filterActionIdentifiers`を追加
  - グラフ構築後、結果取得後にフィルタリングを適用
  - フィルタ指定がない場合は従来通りの動作を維持（後方互換性）
  - フィルタリング結果の警告メッセージを標準エラー出力に表示
  - _Requirements: 1.1, 1.2, 1.4, 6.1, 6.3_

- [x] 3.2 ビュー解析でのフィルタリング適用
  - ビュー依存関係の結果をフィルタリング
  - 指定されたアクションを直接または間接的に使用するビューのみを抽出
  - 部分一致の場合、一致したアクション依存関係のみを結果に含める
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 3.3 アクション解析でのフィルタリング適用
  - アクション依存関係の結果をフィルタリング
  - 指定されたアクションを直接または間接的に呼び出すアクションのみを抽出
  - フィルタ対象のアクション自身が解析対象に含まれる場合も結果に含める
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 4. エラーハンドリングと警告機能の実装
- [x] 4.1 アクション識別子の存在確認と警告を実装
  - 依存グラフ内でアクション識別子の存在を確認
  - 存在しない識別子について標準エラー出力に警告メッセージを表示
  - 複数指定時に一部のみ存在する場合、存在する識別子についてフィルタリングを実行
  - 警告メッセージのフォーマット: `Warning: Action identifier '[identifier]' not found in dependency graph`
  - _Requirements: 1.2, 5.1, 5.4_

- [x] 4.2 フィルタリング結果が空の場合の警告を実装
  - フィルタリング結果が空配列の場合に標準エラー出力に警告を表示
  - 警告メッセージ: `No dependencies found for the specified action identifier(s)`
  - 空配列を正常に返却（エラー終了はしない）
  - _Requirements: 5.2_

- [x] 5. ユニットテストの実装
- [x] 5.1 依存関係フィルタリングのユニットテストを作成
  - 単一のアクション識別子でのフィルタリングをテスト
  - 複数のアクション識別子でのフィルタリングをテスト（OR論理）
  - 存在しないアクション識別子の警告生成をテスト
  - 部分的に存在するアクション識別子の処理をテスト
  - フィルタリング結果が空の場合の警告生成をテスト
  - _Requirements: 1.1, 1.2, 1.3, 5.1, 5.2, 5.4_

- [x] 5.2 CLI引数解析のユニットテストを作成
  - `--filter-action`オプションの正常な解析をテスト
  - 複数のアクション識別子（カンマ区切り）の解析をテスト
  - 空文字列入力のエラーハンドリングをテスト
  - 既存オプション（`--entry-point-patterns`）との組み合わせをテスト
  - _Requirements: 1.1, 1.3, 5.3, 6.2_

- [x] 6. 統合テストとE2Eテストの実装
- [x] 6.1 ビュー解析の統合テストを作成
  - フィルタオプションありでのビュー解析をエンドツーエンドでテスト
  - 既存テストフィクスチャを使用してフィルタリング結果を検証
  - JSON出力形式が配列形式を維持していることを確認
  - _Requirements: 2.1, 2.2, 2.3, 4.1, 4.2, 4.3_

- [x] 6.2 アクション解析の統合テストを作成
  - フィルタオプションありでのアクション解析をエンドツーエンドでテスト
  - 既存テストフィクスチャを使用してフィルタリング結果を検証
  - フィルタ対象のアクション自身が結果に含まれることを確認
  - _Requirements: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [x] 6.3 後方互換性の統合テストを作成
  - フィルタオプションなしでの従来動作の維持を確認
  - 既存の全テストケースが引き続き通過することを確認（回帰テスト）
  - 既存のプログラムAPIが変更なく動作することを確認
  - _Requirements: 1.4, 6.1, 6.3_

- [x] 7. E2Eテストと動作確認
- [x] 7.1 CLIコマンドのE2Eテストを作成
  - `bm-action-dep-parser view ./tests/fixtures/views --filter-action sampleAction`の実行テスト
  - `bm-action-dep-parser action ./tests/fixtures/actions --filter-action action1,action2`の実行テスト
  - 存在しないアクション識別子での警告メッセージ確認
  - フィルタリング結果のJSON出力形式検証
  - _Requirements: すべての要件を統合的に検証_

- [x] 7.2 実際のプロジェクトでの動作確認
  - テストフィクスチャ以外の実際のBaseMachinaプロジェクトでフィルタリング機能をテスト
  - 大規模なプロジェクト（100+エントリーポイント）でのパフォーマンスを確認
  - 様々なアクション識別子パターンでの動作を検証
  - _Requirements: すべての要件を実環境で検証_

- [x] 8. ドキュメントとヘルプメッセージの更新
- [x] 8.1 CLIヘルプメッセージを更新
  - `--help`オプションの出力に`--filter-action`オプションの説明を追加
  - 使用例にフィルタリングのサンプルコマンドを追加
  - 日本語と英語の両方でドキュメントを更新
  - _Requirements: 1.1, 1.3_

- [x] 8.2 READMEドキュメントを更新
  - 新機能の説明をREADME.mdに追加
  - フィルタリング機能の使用例とユースケースを記載
  - 変更影響範囲分析の具体的なワークフローを説明
  - _Requirements: すべての要件のドキュメント化_

## タスク実行時の注意事項

1. **段階的な実装**: 各タスクは独立して完了可能ですが、依存関係を考慮して順次実行してください
2. **テスト駆動開発**: 各機能実装後、すぐにテストを書いて動作を確認してください
3. **後方互換性**: 既存機能に影響を与えないよう、常に既存テストを実行して確認してください
4. **型安全性**: TypeScriptの厳格な型チェックを活用し、`any`型の使用を避けてください
5. **コミット単位**: 各メジャータスク（1.x, 2.x, 3.x...）完了後にコミットすることを推奨します

## 要件カバレッジチェックリスト

- [x] Requirement 1.1: --filter-actionオプション処理
- [x] Requirement 1.2: 存在しないアクション識別子の警告
- [x] Requirement 1.3: 複数アクション識別子のサポート
- [x] Requirement 1.4: フィルタなしの場合の従来動作維持
- [x] Requirement 2.1: ビュー解析でのフィルタリング
- [x] Requirement 2.2: フィルタされたビューの依存パス表示
- [x] Requirement 2.3: 部分一致時の依存関係抽出
- [x] Requirement 3.1: アクション解析でのフィルタリング
- [x] Requirement 3.2: フィルタされたアクションの依存パス表示
- [x] Requirement 3.3: フィルタ対象アクション自身を結果に含める
- [x] Requirement 4.1: JSON出力形式の維持
- [x] Requirement 4.2: フィルタ有無で同一のJSON形式
- [x] Requirement 4.3: 後方互換性の完全維持
- [x] Requirement 5.1: 存在しないアクション識別子の警告
- [x] Requirement 5.2: フィルタリング結果が空の場合の警告
- [x] Requirement 5.3: 無効な入力形式のエラー処理
- [x] Requirement 5.4: 一部のみ存在する場合の部分実行
- [x] Requirement 6.1: オプションなしの場合の出力形式維持
- [x] Requirement 6.2: 既存オプションとの組み合わせ対応
- [x] Requirement 6.3: プログラムAPIの後方互換性
